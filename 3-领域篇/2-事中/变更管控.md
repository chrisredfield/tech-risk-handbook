## 一、变更管控领域概述
### 1. 如何定义变更
要做变更管控，首先我们要对“变更”，或者说分布式系统稳定性领域关心的变更有个清晰的认知。先来看看ITIL（信息技术基础架构库）中对于变更的定义：
> 变更是“添加、修改或删除可能对服务产生直接或间接影响的任何内容”。

简单来说是，**任何导致线上服务状态发生变化的行为叫做变更**。
然而这样的定义过于模糊。比如“状态”这个概念，如果说服务依赖和包含的持久化数据是一种显而易见的状态，那么服务当前所处的、时时流逝着的时钟是否算作“状态”？再比如数据显而易见是“状态”，那么如果用户打开支付宝发起一笔转账，这个行为是否属于“对账务系统的记账表数据状态做了变化”从而应该视作变更？
带着这个问题，我们分析了历史上由变更引发的线上服务故障案例。发现一个共性：它们都是企业内部人员通过某个平台或黑屏命令进行的线上操作。这些内部人员从运维、研发、产品到活动运营等，涵盖了多种角色。于是，变更，或者说做变更管控所需要关心的变更，指的就是“**内部人员触发的任何导致线上服务状态发生变化的行为**”。因此时钟滴答不是变更，用户转账也不是。
### 2. 如何定义变更管控
同样，我们再来看看ITIL中对于变更管控（变更管理）的定义：
> 在从始至终的整个生命周期中跟踪和管理变更以最大程序降低风险的过程。

其中有几个关键词：

- **生命周期**：变更的完整生命周期并不单单指变更动作的执行开始到结束，想要管控变更中的风险，甚至需要从变更提单、审批阶段开始事前对变更中可能出现的风险进行分析。同时，变更动作的结束，并不意味着变更平稳、正确的在线上环境完成，还需要进行一段时间的风险观察/校验。
- **跟踪和管理变更**：需要具备对于变更整个生命周期的**感知和干预能力**。在发现风险时，能够快速、有效的**熔断变更执行**。
- **最大程序降低风险**：虽然通过制定流程标准（比如：如何制定变更计划、谁来审批、过程中应急on-call如何协作），依赖人工也可以观察出一定的变更风险。但基于人工观察，无法避免的问题就是**做不到100%的全面和精细化**。所以，本文讨论的是，**实现一套变更管控系统，应具备的能力**。
## 二、变更管控的实践
### 1. 前言
如前文所述，ITIL中将变更管控的关键因素定义为三个方面：变更生命周期标准、变更的跟踪和管理能力、程序化的风险识别能力。但只要具备了这三点，就是一套成熟的变更管控系统了吗？答案是否定的。接下来本文会展开讲述上述三点以及作为高阶变更管控系统，应具备的能力。
### 2. 变更生命周期定义
如前文所述，要做变更管控，就不能只关心变更动作的开始到结束。需要关注的是从变更提单审批到实际风险校验完成产出变更报告这个完整的流程。因此，我们将变更的生命周期定义如下图：
![](static/chap3-3.png)
接下来，本文会按照图中的步骤，来进一步阐述每个阶段，变更管控系统应具备的能力。
### 3. 变更计划阶段
看到这个阶段，你可能会有疑问：变更工单不是在对应变更平台进行提交的吗？为什么还需要单独有变更计划阶段呢？的确，内部人员在做变更时，会先在相应的变更平台进行提单操作。但这个工单往往仅对变更对象、变更类型、变更内容、推进步骤等基础信息进行了描述。如果仅仅基于此内容进行事前的风险评估，就又演变成了纯粹依靠提单人和审批人的个人经验的丰富度。
所以，在上述信息的基础上，变更计划阶段需要做的是对变更工单的进一步风险分析、变更操作流程、应急方案、验收标准等信息的扩充。为审批人、执行人、验收人、应急人等角色提供更丰富的信息辅助。
#### 3.1 变更风险分析
前文提到变更计划阶段需要有对变更的风险分析能力，这是提供给审批人最重要的信息来源。那么风险分析需要做到哪些事情呢？主要分为以下两个方面：
##### 3.1.1 变更影响面分析
对于信息技术相关企业来说，内部业务往往错综复杂。单一系统发生的变更行为，往往可能波及到整个上下游业务链路，从而带来预期外的业务影响。
变更影响面分析旨在通过程序分析、知识图谱推导、实时数据关联等手段，扩展本次变更从系统程序内部、业务链路、中间件、存储、基础设施等角度对于线上环境的影响。为审批人提供信息辅助的同时，也为后续的风险识别能力提供数据输入。
##### 3.1.2 变更风险识别
在扩充了影响面数据的基础上，需要对信息做进一步的归纳推导，从而分析提炼出关键的风险点信息，提供给审批人进行重点关注。主要包含以下几个方面：

- 变更风险评级：基于既定的分级规范，或各领域专家事前的经验沉淀，对变更的危险程度进行划分。
- 变更风险预警：通过程序分析、知识推导等形式，从代码研发规范、中间件使用、存储使用规范等方面，评估本次变更中的不合理性，进行预警
### 4. 内容审批阶段
在变更计划阶段进行数据扩展及风险分析后，将完整的变更信息按照既定策略转交到对应的评估人、审批人进行审批。对于评估人、审批人的职责划分如下：

- 评估人：对于变更计划给出的风险信息的准确性和遗漏点进行二次确认及补充
- 审批人：评估人完善确认信息后，按照审批策略转交给对应的风险防控团队（主要是SRE/质量）进行审批
### 5. 仿真试运行阶段
由于信息技术相关企业的业务复杂性和流量的时段差异性，事前风险分析给出的风险点都解决后也并不能代表一定不会对线上业务造成影响。所以，在进行真正的变更之前，需要有一个独立的环境，利用线上的历史流量进行真实的变更模拟。
### 6. 灰度分批阶段
变更开始在实际的线上环境开始运行。这里对于变更在线上的生效方式有一个明确的要求：变更一定是逐批次小步骤生效的（金丝雀发布模式）。在此基础上，变更管控系统需要能够实时感知变更的各个生效阶段，并配套相应的风险检测能力，在发现风险的同时快速熔断变更（对应ITIL标准中的跟踪、管理变更及最大程序识别风险）。
基于灰度分批的变更模式，我们提出了前后置切面的变更管控思路，如下图：
![](static/chap3-4.png)
那么，在此变更管控模式下最重要的“金丝雀”们（变更风险防御能力），需要怎么建设呢？我们把它们大致分为如下几类：
#### 6.1 变更前准入性防御
要判断一笔变更在当前时间点或未来某个时间点是否可以执行，需要考虑到多种因素。如：变更是否发生在业务高峰期、变更执行时业务系统的容量是否充足等。我们将其中的因素归纳为以下几个方面：
##### 6.1.1 封网管控
对于国家重大事件、节日、活动保障等关键时间点，稳定性变得尤其重要。此时的变更一旦出现问题，将会给企业带来更为严重的舆论影响。所以作为变更管控平台，需要有针对特殊时段的封网管控能力。更进一步的，可基于“变更风险分析”章节中提到的风险评级能力，做更精细化的封网管控。
##### 6.1.2 变更窗口管控
除重点时间的封网管控外，业务在日常也会存在流量的峰谷变化情况。在业务高峰进行的变更，很可能导致系统出现性能问题，或直接影响更多的用户。所以对于变更平台来说，需要有针对不同业务链路的窗口管控能力。更进一步的，可以基于历史流量变化情况，自动学习出不同业务的流量高峰期，进行管控。
##### 6.1.3 配置合法性校验
企业内部运行的各类系统/业务，往往会依赖各种各样的配置。这些配置类型的变更，配置值往往依赖人工进行填写。其填写过程中可能会存在一定的误操作，这种误操作会导致系统无法解析配置值，严重的甚至可能导致系统崩溃，那么对于配置值的合法性校验就变得尤为重要。但一个企业内部的配置数量往往是极其庞大的，此时就需要变更管控系统能够通过配置项历史变更过的值的类型、变化范围、正则特征等角度，自动进行风险防御。
##### 6.1.4 变更冲突检测能力
同一个实体对象（如应用系统/容器/配置项等），当有多笔变更同时对其进行操作时，可能会存在一定的冲突。最简单的例子就是同时对同一个配置项进行两次推送操作。复杂的例如：人员a对A应用容器进行代码镜像部署的同时，人员b同时对A应用容器做了缩容变更。这样可能会导致应用在线容量不足，引发容量问题。解决这类问题的思路是在同一实体对象进行变更的同时，对其进行“加锁”，当具有冲突性的变更同时执行时，进行拦截提示。
#### 6.2 变更后可观测性防御
变更后，风险防御需要关注的是“本次变更是否对原有业务造成影响”（而不是新业务上线效果是否符合预期）。那么如何评估原有业务的可用性，我们大致分为下图中的三类：
![](static/chap3-5.png)
##### 6.2.1 监控时序指标异常检测
衡量一个系统/业务的可用性，最直观的当然就是检测对应的监控指标是否出现波动。但在前文所述的灰度分批变更模式下，无论是通过整体集群的监控大盘，还是通过单机指标的监控，都无法很好的反映当前这个批次是否出现问题（因为一个批次的变更往往涉及到一批容器）。此时就需要一个动态采集/聚合的能力，获取到本批次中所有容器的监控指标时序曲线，再配合异常检测算法进行变更前后的时序异常的识别。至于异常检测算法模型，市面上有太多可供选择，本文不做赘述。
##### 6.2.2 日志异常检测
除了监控外，衡量业务的运行情况，还可以通过系统所打印的关键日志或错误日志进行识别。通过采集单批次变更后全部容器中的日志数据，对其进行格式匹配或正则转换，再配合相应的相似度拟合算法，即可判断变更后日志中是否出现了新增的错误码/异常，以及存量的错误码/异常变化趋势。
##### 6.2.3 链路异常检测
对于单一系统的变更，其影响很可能并不局限于这个系统本身，更可能波及到其上下游，或整个业务链路的入口/末尾。那么就需要变更后能够具备对整条业务链路进行异常检测的能力。简单模式下，通过trace日志聚合即可反映出系统间每笔流量的调用异常情况以及业务错误码的变化情况，但这种方式的问题在于计算量过于庞大，极度损耗资源。那么较为复杂的方式是结合中间件能力，将每笔流量的调用携带特殊标记进行透传染色，这样既能明确感知一笔流量所经过的系统链路，又能在透传的同时携带系统交互的关键信息，从而实现整条链路的异常检测。
#### 6.3 防御有效性验证
一个成熟的变更管控系统，线上环境中一定会沉淀相当大数量级的规则化或智能化的校验能力，这些校验能力会不停的在迭代更新或问题修复。那么如何保障这些能力在新版本中还能保持较高的有效性，或者在某些变更场景/业务系统下这些防御能力是否能很好的发现业务风险。这部分验证工作是相当耗时耗力的，所以对于变更管控系统而言，需要一个灵活且可靠的防御有效性验证手段。这种验证手段通常可以结合“混沌工程”进行攻击验证。
#### 6.4 风险可恢复手段
即使变更防御准确无误的检测出了风险，如果没有人及时的进行应急，业务也是处于有损的状态。因此，对于变更管控平台而言，除了能够及时的发现风险外，还需要对于变更中发生的风险，有快速有效的处置能力。
### 7. 变更度量阶段
一笔变更的结束，并不代表其中的操作流程一定是标准且符合规范的。所以企业内部往往会有专业的人员进行度量审计，及时发现其中不合规的地方。同时，基于变更过程中的各类数据记录（变更执行数据、风险分析数据、风险防御数据等）进行度量，也能更好的反映出变更过程中的效率问题。
