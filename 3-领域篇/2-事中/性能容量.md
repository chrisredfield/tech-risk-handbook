## 一、概述
容量是技术风险领域重要的课题之一，特别随着云原生技术的发展和普及，用户在容量“成本、效率、稳定性”等方面也提出了越来越多的诉求。

- 成本方面：由于资源规格设置不当、用户预留过多资源、业务低峰期资源得不到利用等等原因导致集群资源利用率不高，资源浪费情况严重。因此，如何提升资源利用率节省成本，成为了用户的首要诉求。
- 稳定性方面：由于流量的不确定性，内外部流量经常性突变，业务持续迭代和硬件等因素导致容量在动态变化等，导致容量风险敞口也越来越大。因此，如何保障容量稳定性是用户关注的重点。
- 效率方面：由于经典paas扩缩容效率和成功率不能满足快速弹性的需求，用户快速迭代也需要极致的资源交付效率。因此，提升弹性伸缩和资源交付效率是用户关注的重要方面。
## 二、技术实践
### 前言
本文将围绕成本优化、容量风险防控、资源运营等方面介绍相关容量技术实践，使用户在容量“成本、稳定性、效率”等方面得到提升。
### 成本优化
提升资源利用率以节省成本是云原生用户的重要目标，本节将通过容量弹性伸缩、动态调度、在离线混部等技术介绍容量在成本优化方面的实践。
#### 弹性伸缩
##### 水平弹性伸缩 HPA 
业务运行时经常会申请更多容器保障稳定性，容器数量超出了实际需求，并且业务请求具有波动周期，在波峰和波谷时间对于容量的需求是不一样的。
水平自动伸缩(Horizontal Pod Autoscaler)技术可以根据业务负载规律或业务核心指标自适应的调整容器数量，以满足不同时间段的容量需求。最理想的情况是，每时每刻的容器数量刚好够应用当时的业务需求用，达到成本和业务需求的完美平衡点。基于蚂蚁自研的HPA技术，蚂蚁累计缩容超过20w core，为公司节省了上亿的硬件采购成本。 
##### 垂直弹性伸缩 VPA
垂直弹性伸缩(Vertical Pod Autoscaler)技术可以基于Pod的资源使用情况自动调整Pod的资源占用限制，从而让集群将Pod调度到有足够资源的最佳节点上。VPA可以通过向用户推荐更合理的Request，在保证容器有足够使用资源的情况下，提高集群的资源利用率。
相对HPA，VPA具有以下优势：

- VPA可以为有状态应用实现扩容，HPA则不适合有状态应用的水平扩容。
- 有些应用Request设置过大，缩容至一个Pod时资源利用率仍然很低，此时可以通过VPA进行垂直缩容提高资源利用
##### 集群弹性伸缩 CA
HPA和VPA都是在Pod层面的弹性伸缩，只会让集群资源总量不变的情况下有更多的空余资源，并不能改变集群资源总量，而集群资源使用量直接决定了账单费用，如果在资源总量上进行弹性伸缩将帮用户节省使用成本。
集群弹性伸缩(Cluster Autoscaler)技术通过自动扩容和收缩集群node节点，以真正实现资源利用率的提升，是云用户成本优化的关键。
CA使用场景：

- 在集群容量不足时，自动扩容新的节点
- 在集群资源利用率比较低时，自动释放空闲节点以节省开支
#### 动态调度
##### 负载感知调度
云原生k8s 调度是根据集群当前的资源剩余情况做出的最佳调度，但是资源剩余情况是一个静态值，并不代表集群资源实际使用情况，动态负载均衡调度则可以感知节点实际工作负载进行调度，将Pod优先调度到负载较低的节点上，实现节点负载均衡的目标，同时也可以避免因为负载过高而导致的系统故障。
##### 重调度
云原生k8s调度是静态一次性的行为，但是k8s集群是非常动态的，随着时间的推移，集群可能会出现不均衡状态，比如节点间负载的不均衡，资源碎片等问题。重调度(DeScheduler)技术可以根据一些规则和配置策略来帮助我们重新平衡集群状态。
#### 在离线混部
业务服务主要可以分为两大类：在线服务和离线服务

- 在线服务：运行时间长，流量和资源使用有潮汐特征，时延敏感，对稳定性要求高，比如交易服务。
- 离线服务：运行时间短，运行期间资源利用率比较高，时延不敏感，容错率高，允许重运行，比如Hadoop下的MapReduce、Spark作业。

在离线混部则主要是通过在线服务运行过程中资源空闲的时间段填充离线服务，来提高资源利用率，帮用户节省业务成本。
#### 性能优化
##### 性能回归
在日常研发迭代中，业务owner的代码实现很有可能优先满足业务功能忽视了代码运行性能，对于性能的忽视会造成单机吞吐量的下降，导致需要补充更多的资源承载相同的业务量级
应用性能回归技术可以在应用在生产发布运维前在仿真环境进行应用性能回归评测，在这个过程中通过实验室环境变量控制，基于专家经验和指标对比，感知到性能衰退的异常变动以帮助应用owner进行性能衰退感知，同时支持按业务场景精细化到接口方法乃至参数维度的流量模型，并与性能分析产品联通自动产出分析报告，协助用户进行性能衰退感知和优化。
##### 性能分析
通过对性能指标数据的实时采集、清洗、转换、调和、可视化呈现，助力技术人员深入分析定位应用性能问题。通过CPU、内存、线程、方法调用消耗等数据采集统计再结合可视化的分析，帮助用户有效地剖析性能问题根因；

- 集群分析：聚合应用集群特征数据（机型、内核、jdk版本、容器状态、...）和运行时数据（Cpu、Memory、JVM、RT、...），提供多维分析视图，帮助用户排查由于底层基础设施差异导致的应用集群内性能不均衡问题。
- 节点分析：聚合多种自研&开源性能数据采集工具（trace_cost、perf、coredump、profiler、...），提供一站式（资源+JVM+业务）的业务性能数据采集和分析方案，通过可视化方案帮助业务分析性能瓶颈问题或性能可优化点；沉淀性能风险知识库，支持智能化的性能风险诊断，用户无需具备丰富的技术知识与问题解决经验即可使用产品实现对应用实例的性能问题诊断，并给出合理的优化建议与直观的诊断报告
### 容量风险防控
互联网历史上多家大厂曾发生过因容量问题引起的线上故障，比如某年春晚某头部电商的摇一摇红包活动短暂宕机，微博在娱乐圈出现热门事件时的频繁宕机，都对用户造成了巨大影响，因此容量稳定性非常重要，可以通过限流、变更防御、容量风险识别和自愈等等手段构建容量风险防控体系。
#### 自适应限流
我们经过历史案例的分析，绝大多数的容量问题还是由于少部分异常流量触发，如果能够精准的识别异常流量，是可以做针对性的限流打击，从而减少潜在的容量风险。自适应限流可以通过提前配置或者自动识别异常流量方式进行精细化限流。类似的限流产品有蚂蚁的mosn自适应限流、阿里集团的sentinal、微信的DAGOR等。
#### 变更防御
除了流量波动会造成容量异常，变更同样也是容量异常产生的重要因素，比如部署资源变更(HPA、VPA变更等)、业务迭代后性能衰减、容灾切换或压测导致整体容量变化、基础设置变更等。核心策略是通过变更影响面分析，得到潜在的影响范围，然后对影响到的实体进行指标异常检测，对于检测到的单指标异常，通过容量防御模型进行识别阻断。
#### 风险识别
很多时候线上问题总是被动发现，很难在业务研发之前去主动发现容量异常，因此建设一套旁路容量风险识别和自愈系统非常有必要。可以分为两个部分：Decision（决策）、Action（恢复），其中decision作为容量自愈体系的脑部，负责检测容量异常情况和异常情况下需要承载异常流量的资源数量；action作为手臂负责按照指令快速恢复。目前蚂蚁已经上线相关系统，为减少容量风险故障提供了有力帮忙。
### 资源运营
资源运营技术是指通过对资源的管理，统筹和规划，盘活资源高效率的管理运营资源的技术。 
#### 配额管理
在云原生k8s架构下，资源默认被多个租户共享使用，租户间不可避免地存在资源竞争问题。为了满足不同租户多样的服务质量需求，集群管理员需要为租户设置非常精细的资源配额以及资源限制。ResourceQuota可以对每个namespace的资源消耗总量提供限制。 可以限制命名空间中某种类型的对象的总数目上限，也可以限制命令空间中的 Pod 可以使用的计算资源的总上限。
#### 资源计量
如果说资源优化技术是我们节约成本的右手，那么应用的资源计量就是我们节约成本的左手，只有大家能够明确看到有财务成本上的节约，更多的同学才会有一定的动力来参与成本优化。因此，需要建设一套专业的方案和统一的标准对成本进行采集和计量，驱动业务在做技术选型有对成本上的考虑。通过精细化的计量提供业务从固定成本(fixed cost) 到按需计量(pay as you go)的账单模式（billing mode）。
## 三、扩展
### 数据智能化
随着业务快速发展，集群规模的快速增长，业务对容量诉求也越加复杂的情况下，通过人工经验管理应用资源的方式会很快达到瓶颈。因此建立一套自动化、智能化的适用于容量调度的大数据方案势在必行。可以通过大数据智能化解决以下容量问题：

- 稳定性问题：预判和识别容量引起或和容量相关的风险问题，并具备预防和快速恢复能力。主要是容量异常识别、流量增长预判、热点机器识别几个能力，以及对应的限流、扩容、流量调拨等智能化决策能力。
- 成本问题：以合理的成本支撑业务发展，并不断驱动降低成本。主要是成本大数据分析能力、容量智能化弹性伸缩能力。效率问题：资源需求和供给过程中，效率的问题。主要是人工提单量、供给成功率等。
### 分时调度
分时调度是指将一份资源在不同的时间段提供给不同的应用使用，可以极大的提高资源效率，类似于潮汐车道。传统的分时复用依赖资源的扩缩容，而Java应用因为业务特性的原因造成启动很慢和扩缩容成功率低，“资源大挪移”往往需要好几个小时，因此蚂蚁专门研发了基于云原生的分时调度技术，核心技术思路是灵活控制节点上资源的使用，在不同的时间段把资源分配给需要的应用（激活态应用），限制不在当前大促状态的应用资源使用（保活态应用），从而达到多个应用共享资源的目的。基于分时调度技术，蚂蚁日常和大促为公司节省超过5w core，可以做到分钟级别资源切换。
